@using Models;
@using Admin.Helpers;
@{
    ViewBag.Title = "Car Images";
    FunctionHelper _functionHelper = Session["Global_FunctionHelper"] as FunctionHelper;
    string _carID = Request.QueryString["carID"];
    List<CarImage> _lstAvailable = ViewBag.AvailableImages as List<CarImage>;
    string _httpLocation = _functionHelper.GetFromConfig("httpLocation");
}


@using (Html.BeginForm("AddCarImages", "CarManagement", FormMethod.Post, new { @novalidate = "novalidate", @class = "form-horizontal form-label-left", enctype = "multipart/form-data" }))
{
    @Html.Hidden("CarID", @_carID)
    @Html.Hidden("CarImages")
    <div class="row">
        <div class="col-md-12">
            <input type="file" name="flUploadImages" id="flUploadImages" multiple />
            <button id="btnUpload" type="button" class="btn btn-success">Upload Images</button>
        </div>
    </div>
    <div class="row uploadedImagesContainer">
        @if (_lstAvailable != null && _lstAvailable.Count > 0)
        {
            foreach (CarImage item in _lstAvailable)
            {
                <div class="col-lg-3 col-md-4 col-xs-6 thumbCarGallery">
                    <a class="thumbnail" href="javascript:void(0)">
                        <img class="img-responsive" src="@String.Concat(_httpLocation, item.Image)" alt="">
                    </a>
                </div>
            }
        }
    </div>
    <div class="ln_solid"></div>
    <div class="form-group">
        <div class="col-md-6 col-md-offset-3 text-right">
            <button id="btnCancel" type="button" class="btn btn-danger" onclick="window.location.href='/CarManagement/Car'">Cancel</button>
            <button id="btnSubmit" type="submit" class="btn btn-success">Submit</button>
        </div>
    </div>
}
@section scripts {
    <script>
        var html = "<div class='col-lg-3 col-md-4 col-xs-6 thumbCarGallery'><a class='thumbnail' href='javascript:void(0)'><img class='img-responsive' src='{0}' alt=''></a></div>";

        $(function () {
            $("#carListItem").addClass("current-page");
            $("#carListItem").parent().css("display", "block");
            $("#carListItem").parent().parent().addClass("active");
        })

        $("#btnUpload").click(function () {
            var fileUpload = $('#flUploadImages')[0];
            var formData = new FormData();
            for (var i = 0; i < fileUpload.files.length; i++) {
                formData.append('file', fileUpload.files[i]);
            }

            $.ajax({
                url: '/CarManagement/UploadCarImages',
                type: 'POST',
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false,  // tell jQuery not to set contentType
                success: function (data) {
                    if (data != null && data != "") {
                        var arrData = data.split("|");
                        for (var i = 0; i < arrData.length; i++) {
                            var img = arrData[i];
                            if (img != null && img != "") {
                                var oldHtml = $(".uploadedImagesContainer").html();
                                $(".uploadedImagesContainer").html(oldHtml + html.replace("{0}", img).replace("~", ".."));
                            }
                        }
                        alert("Images(s) Uploaded Successfully");
                    }
                }
            });

            return false;
        });

        $("#btnSubmit").click(function () {
            var _images = "";
            $(".uploadedImagesContainer .thumbCarGallery").each(function (i, obj) {
                _images += $(this).find("img").attr("src") + "|";
            });
            $("#CarImages").val(_images);
        });

        $(document).on("click", ".thumbnail", function () {
            if (confirm("Are you sure you want to delete?"))
                $(this).parent().remove();
        });
    </script>
}